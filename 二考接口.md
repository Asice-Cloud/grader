# 2024挑战网技术部后端二考接口文档

技术部后端的二考时间预计为 `2023/12/07 00:00(UTC+8) 至 2023/12/18  06:00 (UTC+8)` **(我抄的其实 因为我不知道啥时候考)**

期间引领人大部分时间将会神隐，但至少保证每交完一稿后会有回复，如果引领人没有回复可以寻找其他引领人并举报下自己的引领人)
**每次交完一稿后都要及时联系引领人**

如若API文档出现错误或不易理解的部分，请及时联系引领人，引领人在确定是API文档的问题后会及时在大群里更新API文档或进行修改，所以请不要屏蔽大群错过关键信息😡😡😡

## 考核内容

1. 熟练掌握tz-gin的项目结构和使用方式
2. 熟练掌握sql语句和mysql相关操作以及gorm的操作
3. 掌握JWT流程

## 考核要求

- 通过提供的API文档(抢票系统)实现一个后端系统，完整实现API文档的所有接口

  > (加分点) 后端会涉及到**高并发**场景， 我们建议使用**sql事务**来完成，具体需要自行模拟并处理情况
  >
- 考核结果将通过**黑盒测试**，因此应当仔细查看以下每一条说明

  + 敏感数据做加密处理，例如密码等。引领人会查看源码，保证数据的安全性 (加密算法不限)
  + URL、request与response要求和文档要求保持一致
  + 本次二考所使用的数据库一律命名为 `tenzor2024` ，密码为 `123456`。不一致者打回
  + POST和PUT方法可以有请求体，GET和DELETE方法没有请求体（芝士常识）
- 二考使用git提交，在 `homework.tiaozhan.com`上新建一个仓库 `finaltenzor`并设置为私密，并将你的引路人拉入git仓库
- 将Postman或ApiFox的请求和响应保存为json文件，并提交到仓库中(参考对应的文档)
- 将数据库的表结构另存为sql文件，放在tz-gin的sql文件夹下
- 如果遇到问题，请学会查看 go 自身的报错信息并尝试解决问题。二考过程中引领人可以回答有关知识，但是不会直接说出答案。很多方面的问题都可以查看官网来解决
- 可以使用联表查询的地方要使用联表查询

## 介绍

你是tzu的一名大学生🥰， 在学校选课网站无数次崩掉之后你决定帮教务处重构一版选课网站😡. 为了能够与旧版的前端适配， 你拿到了一份接口文档:

- 作为管理员
  - [`POST /api/admin/courses` 添加课程](#添加课程)
  - [`DELETE /api/admin/courses/{courseId}` 根据课程编号删除一门课程](#删除课程)
  - [`PUT /api/admin/courses` 更新课程信息](#更新课程)
  - [`GET /api/admin/courses` 获取所有的课程列表](#查询课程)
  - [`GET /api/admin/courses/{courseId}` 获取一门课的详情](#获取课程)
  - [`GET /api/admin/students` 获取学生列表](#获取学生列表)
  - [`GET /api/admin/students/{studentId}` 获取某个学生](#获取学生具体信息)
- 作为学生
  - [`POST /api/register` 学生首先需要在选课网站注册](#学生注册)
  - [`POST /api/login` 登录](#登录)
  - [`DELETE /api/logout` 退出登录](#退出登录)
  - [`GET /api/userinfo` 获取当前用户状态](#获取当前用户状态)
  - [`GET /api/courses` 获取课程列表](#获取课程列表)
  - [`GET /api/courses/{courseId}` 根据课程编号获取某个课程详情](#获取课程详情)
  - [`POST /api/choose-courses` 抢课!😈](#抢课!😈)
  - [`DELETE /api/courses/{courseId}` 放弃选择这门课](#放弃课程)
  - [`GET /api/user/courses` 查看自己已经抢到的课](#查看抢到的课)
  - [`GET /api/user/schedule` 获取用户当前已选课形成的课表](#获取课表)

**注意:**

为了提高选课网站的鲁棒性， 我们选用的工作流程如下:

- 认证服务 (Auth Service)
  - 主要用于维护用户会话状态
  - 负责用户登录， 颁发JWT
- 选课服务 (Course Service)
  - 提供选课相关API， 如查看课程以及抢课等
  - 仅验证JWT， 并不会保存会话状态
- 工作流程
  - 用户登录认证服务， 获取访问选课服务API的token
  - 客户端携带token去访问选课服务
  - 选课服务依赖JWT验证用户身份， 而不是session

你需要设计**两个后端**， 一个用于认证服务， 一个用于选课服务， 两者间的交互使用**JWT**交流。有关JWT的详细内容请看我们给出的[JWT文档](./JWT.md)

## 错误处理

错误时返回状态码仍然是200， 但是返回统一为:

```
{
	"success": false，
	"error": "..."
}
```

下述的接口详情的response都是成功时的返回，其中 `*`为必填项，其余为选填项

## 管理员部分

### 添加课程

`POST /api/admin/courses`

- Request

| body            | type     | example          |
| --------------- | -------- | ---------------- |
| course_name (*) | string   | zao's 前端课     |
| capacity (*)    | number   | 100              |
| teachers (*)    | string[] | ["zao"， "bobo"] |
| time (*)        | string   | "Wed. 3-4"       |
| location (*)    | string   | "B204"           |

**注意:**

1. 考虑时间冲突， 教室冲突以及教师冲突

- Response

```
{
	"success" : true，
    "data":{
        "Id":4，
    }
}
```

### 删除课程

`DELETE /api/admin/courses/{courseId}`

- Request

| param         | type   | example |
| ------------- | ------ | ------- |
| course_id (*) | number | 1       |

- Response

```
{
	"success" : ture
}
```

### 更新课程

`PUT /api/admin/courses`

- Request

| body          | type     | example             |
| ------------- | -------- | ------------------- |
| course_id (*) | number   | 1                   |
| course_name   | string   | "tenzor的奇妙冒险"  |
| capacity      | number   | 100                 |
| teachers      | string[] | ["夏和小"， "bobo"] |
| time          | string   | "Wed. 3-4"          |
| location      | string   | "B204"              |

- Response

```
{
	"success" : true
}
```

### 查询课程

`GET /api/admin/courses`

- Request

| query       | type     | example          |
| ----------- | -------- | ---------------- |
| page (*)    | number   | 1                |
| limit (*)   | number   | 10               |
| course_name | string   | "tenzor"         |
| teachers    | string[] | ["zao"， "bobo"] |
| time        | string   | "Wed. 3-4"       |
| location    | string   | "B204"           |

**注意:**

1. `course_name`需要支持模糊搜索， 如"tenzor"可以匹配到"tenzor的奇妙冒险"
2. `teachers`指的是找到这个teachers列表中的所有teacher的课， 比如 `["zao"， "bobo"]`可以匹配到所有 `"zao"`或 `"bobo"`的课程

- Response

```
{
	"success" : ture，
	"size" : 123，
	"data" : [
		{
			"id" : 1，
			"course_name" : "zao's 前端课"，
			"capacity" : 100，
			"teachers" : [
				"zao"，
				"bobo"
			]，
			"time" : "Wed. 3-4"，
			"location" : "B204"
		}，
		{
			"id" : 2，
			"course_name" : "tenzor的奇妙冒险"，
			"capacity" : 100，
			"teachers" : [
				"夏和小"，
				"bobo"
			]，
			"time" : "Wed. 3-4"，
			"location" : "B304"
		}
	]
}
```

### 获取课程

`GET /api/admin/courses/{courseId}`

- Request

| param         | type   | example |
| ------------- | ------ | ------- |
| course_id (*) | number | 1       |

| query     | type   | example |
| --------- | ------ | ------- |
| page (*)  | number | 1       |
| limit (*) | number | 2       |

- Response

```
{
	"success" : true，
	"id" : 1，
	"course_name" : "tenzor的奇妙冒险"
	"capacity" : 100，
	"time" : "Wed. 3-4"，
	"location" : "B204"，
	"teachers" : [
		"zao"，
		"bobo"
	]，
	"total_students" : 100，
	"students" : [
		{
			"name" : "HappyBug"，
			"student_id" : "1145140000"
		}，
		{
			"name" : "sunfish"，
			"student_id" : "0011451400"
		}
	]
}
```

### 获取学生列表

`GET /api/admin/students`

- Request

| query        | type   | example  |
| ------------ | ------ | -------- |
| page (*)     | number | 1        |
| limit (*)    | number | 10       |
| student_name | string | "Bug"    |
| student_id   | string | "114514" |

**注意:**

1. `student_name`需要支持模糊搜索

- Response

```
{
	"success" : true，
	"students" : [
        {
            "student_name" : "HappyBug"，
            "student_id" : "1145140000"，
            "total_courses" : 5
        }，
        {
        	"student_name" : "sunfish"，
            "student_id" : "0011451400"，
            "total_courses" : 2
        }
	]
}
```

### 获取学生具体信息

`GET /api/admin/students/{studentId}`

- Request

| param          | type   | example      |
| -------------- | ------ | ------------ |
| student_id (*) | string | "0011451400" |

- Response

```
{
	"success" : true，
	"student_name" : "HappyBug"，
	"courses" : [
        {
            "id" : 1，
            "course_name" : "tenzor的奇妙冒险"
            "capacity" : 100，
            "teachers" : [
                "zao"，
                "bobo"
            ]，
           	"time" : "Tues. 3-4"，
            "location" : "B204"，
        }，
        {
            "id" : 2，
            "course_name" : "zao's 前端课"，
            "capacity" : 100，
            "teachers" : [
                "zao"，
                "bobo"
            ]，
            "time" : "Wed. 3-4"，
            "location" : "B204"
        }
	]
}
```

## 学生部分

### 学生注册1

`POST /api/register`

- Request

| body          | type   | example    |
| ------------- | ------ | ---------- |
| name(*)       | string | HappyBug   |
| password(*)   | string | pαssw0γd |
| student_id(*) | string | 0011451400 |

**注意:**

1. 在这里 `student_id`是主键， 所以不允许重复

- Response

```
{
	"success" : true 
}
```

### 登录 1

`POST /api/login`

- Request

| body          | type   | example    |
| ------------- | ------ | ---------- |
| student_id(*) | string | 0011451400 |
| password(*)   | string | pαssw0γd |

- Response

```
{
	"success" : true
}
```

### 退出登录 1

`DELETE /api/logout`

- Response

```
{
	"success" : true
}
```

### 获取当前用户状态 1

`GET /api/userinfo`

- Response

```
{
	"success" : true，
	"student_name" : "HappyBug"，
	"student_id" : "0011451400"，
}
```

### 获取课程列表 1

`GET /api/user/courses`

- Request

| query       | type     | example          |
| ----------- | -------- | ---------------- |
| page (*)    | number   | 1                |
| limit (*)   | number   | 10               |
| course_name | string   | tenzor           |
| teachers    | string[] | ["zao"， "bobo"] |
| time        | string   | "Wed. 3-4"       |
| location    | string   | "B204"           |

**注意:**

1. `course_name`支持模糊搜索
2. `teachers`指的是找到这个teachers列表中的所有teacher的课， 比如 `["zao"， "bobo"]`可以匹配到所有 `"zao"`和 `"bobo"`的课程

- Response

```
{
	"success" : true，
	"total" : 100，
	"courses" : [
        {
            "id" : 1，
            "course_name" : "tenzor的奇妙冒险"
            "capacity" : 100，
            "teachers" : [
                "zao"，
                "bobo"
            ]，
           	"time" : "Tues. 3-4"，
            "location" : "B204"，
        }，
        {
            "id" : 2，
            "course_name" : "zao's 前端课"，
            "capacity" : 100，
            "teachers" : [
                "zao"，
                "bobo"
            ]，
            "time" : "Wed. 3-4"，
            "location" : "B204"
        }
	]
}
```

### 获取课程详情 1

`GET /api/user/courses/{courseId}`

- Request

| param         | type   | example |
| ------------- | ------ | ------- |
| course_id (*) | number | 1       |

- Response

```
{
	"success" : true，
	"id" : 1，
    "course_name" : "tenzor的奇妙冒险"
    "capacity" : 100，
    "teachers" : [
        "zao"，
        "bobo"
    ]，
    "time" : "Wed. 3-4"，
    "location" : "B204"，
}
```

### 抢课😈 1

`POST /api/user/choose-courses`

- Request

| body          | type   | example |
| ------------- | ------ | ------- |
| course_id (*) | number | 1       |

**注意:**

1. 考虑到并发
2. 考虑时间冲突

- Response

```
{
	"success" : true
}
```

### 查看抢到的课 1

`GET /api/user/courses`

- Request

| query     | type   | example |
| --------- | ------ | ------- |
| page (*)  | number | 1       |
| limit (*) | number | 10      |

- Response

```
{
	"success" : true，
	"total" : 10，
	"courses" : [
        {
            "id" : 1，
            "course_name" : "tenzor的奇妙冒险"
            "capacity" : 100，
            "teachers" : [
                "zao"，
                "bobo"
            ]，
           	"time" : "Tues. 3-4"，
            "location" : "B204"，
        }，
        {
            "id" : 2，
            "course_name" : "zao's 前端课"，
            "capacity" : 100，
            "teachers" : [
                "zao"，
                "bobo"
            ]，
            "time" : "Wed. 3-4"，
            "location" : "B204"
        }
	]
}
```

### 获取课表 1

`GET /api/user/schedule`

- Response

```
{
	"success" : true，
	"courses" : {
		"Mon" : [
            {
                "id" : 44，
                "course_name" : "做e时代的主人"，
                "teachers" : [
                    "zao"，
                    "bobo"
                ]，
                "time" : "Mon. 1-2"，
                "location" : "A102"
            }，
            {
                "id" : null，
                "course_name" : null，
                "teachers" : []，
                "time" : "Mon. 3-4"，
                "location" : null
            }，
            {
                "id" : 22，
                "course_name" : "丹砂引领人教程"，
                "teachers" : [
                    "HappyBug"，
                    "sunfish"
                ]，
                "time" : "Mon. 5-6"，
                "location" : "挑战阁楼"
            }，
            ...
    	]，
		"Tue" : [
    		...
    	]，
    	...
	}
}
```

**注意:**

1. 为了方便前端渲染课程， 即使在某个时间段没有课程， 也需要返回一个空结构体 (记得初始化时间为这个时间段)

### 放弃课程

`DELETE /api/user/course/{courseId}`

- Request

| param     | type   | example |
| --------- | ------ | ------- |
| course_id | number | 1       |

- Response

```
{
	"success" : true
}
```
